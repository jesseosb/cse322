<!DOCTYPE html>
<html>

<head>
    <title>Update Beers</title>
    <link rel="stylesheet" href="beerstyle.css">
    <meta charset="utf-8">
    <meta name="author" content="Jesse Oesterblad">
    <h1 style="text-align:center">Beer List Manager</h1>
</head>


<body>


    <button onclick='myAddRow("name", "birthPlace", "type", "-1")'>Create row</button>
    <!--<button onclick="myDeleteRow(1)">Delete row</button>-->
    <button onclick="transform()">Transform</button>

    <table id="myTable">
    </table>



    <script type="text/javascript">
        var rowNum = 0;

        function transform() {
            var httpRequest;
            // {
            var beerList = "";

            //gets table
            var myTable = document.getElementById('myTable');

            //gets rows of table
            var rowLength = myTable.rows.length;

            //loops through rows    
            for (var i = 1; i < rowLength; i++) {

                //gets cells of current row  
                var myCells = myTable.rows.item(i).cells;

                // generates each line of the .txt file
                var transformedLine = myCells.item(1).firstChild.innerHTML + ";" + myCells.item(2).firstChild.innerHTML + ";" + myCells.item(3).firstChild.innerHTML + "\n";

                // appends each line
                beerList += transformedLine;

                makeRequest('beers.php', beerList);
            }

            function makeRequest(url, beerList) {
                httpRequest = new XMLHttpRequest();

                if (!httpRequest) {
                    alert('Giving up :( Cannot create an XMLHTTP instance');
                    return false;
                }
                httpRequest.onreadystatechange = alertContents;
                httpRequest.open('POST', url);
                httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                httpRequest.send('beerList=' + encodeURIComponent(beerList));
            }

            function alertContents() {
                if (httpRequest.readyState === XMLHttpRequest.DONE) {
                    if (httpRequest.status === 200) {
                        alert("Updated beersList.txt");
                    }
                    else {
                        alert('There was a problem with the request.');
                    }
                }
            }
        }

        var xmlhttp;
        if (window.XMLHttpRequest) { // code for IE7+, Firefox, Chrome, Opera, Safari
            xmlhttp = new XMLHttpRequest();
        }
        else { // code for IE6, IE5
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        if (xmlhttp != null) {
            xmlhttp.open("GET", "beerslist.txt", false); // false makes this synchronous! SJAX?
            xmlhttp.send();
            var text = xmlhttp.responseText; // contains the contents of the .txt file 

            // processes one line at a time.
            var lines = text.split("\n");
            window.onload = function(evt) {
                for (var n = 0; n < lines.length; ++n) {
                    var line = lines[n].split(";");
                    if (line.length >= 3) {
                        myAddRow(line[0], line[1], line[2]);
                    }
                }
                var table = document.getElementById("myTable");
                var row = table.insertRow(0);
                row.innerHTML = "<th></th><th>Brewery - Beer Name</th><th>Brewery Location</th><th>Type</th><th></th>";
            };

        }

        function myAddRow(name, birthplace, type, thisRow) {
            name = name || 'name';
            birthplace = birthplace || 'birthplace';
            type = type || 'type';
            thisRow = thisRow || rowNum + 1;
            var table = document.getElementById("myTable");
            if (thisRow > rowNum) {
                rowNum++;
                var row = table.insertRow(0);
            }
            else if (thisRow == -1) {
                rowNum++;
                var row = table.insertRow(1);
                thisRow = rowNum;
            }
            else {
                var row = table.insertRow(rowNum - thisRow);
            }
            var cell0 = row.insertCell(0);
            var cell1 = row.insertCell(1);
            var cell2 = row.insertCell(2);
            var cell3 = row.insertCell(3);
            var cell4 = row.insertCell(4);
            cell0.innerHTML = thisRow;
            cell1.innerHTML = '<span id="nameID' + thisRow + '" cols=15 rows=1>' + name + '</span>';
            cell2.innerHTML = '<span id="birthplaceID' + thisRow + '" cols=15 rows=1>' + birthplace + "</span>";
            cell3.innerHTML = '<span id="typeID' + thisRow + '" cols=15 rows=1>' + type + "</span>";
            cell4.innerHTML = '<div class="button"><button onclick="myEditRow(\'' + thisRow + '\',\'' + escape(name) + '\',\'' + escape(birthplace) + '\',\'' + escape(type) + '\')">Edit</button> <button onclick="myRemoveRow(\'' + thisRow + '\',\'' + escape(name) + '\',\'' + escape(birthplace) + '\',\'' + escape(type) + '\')">Delete</button></div>';
        }

        // function myAddTags() {

        // }

        function myEditRow(thisRow, name, birthplace, type) {
            document.getElementById("myTable").deleteRow(rowNum - thisRow + 1);
            var table = document.getElementById("myTable");
            var row = table.insertRow(rowNum - thisRow + 1);
            var cell0 = row.insertCell(0);
            var cell1 = row.insertCell(1);
            var cell2 = row.insertCell(2);
            var cell3 = row.insertCell(3);
            var cell4 = row.insertCell(4);
            cell0.innerHTML = thisRow;
            cell1.innerHTML = '<textarea id="nameID' + thisRow + '" cols=15 rows=1>' + unescape(name) + '</textarea>';
            cell2.innerHTML = '<textarea id="birthplaceID' + thisRow + '" cols=15 rows=1>' + unescape(birthplace) + "</textarea>";
            cell3.innerHTML = '<textarea id="typeID' + thisRow + '" cols=15 rows=1>' + unescape(type) + "</textarea>";
            cell4.innerHTML = '<button onclick="myConfirmRow(\'' + thisRow + '\',document.getElementById(\'nameID' + thisRow + '\').value,document.getElementById(\'birthplaceID' + thisRow + '\').value,document.getElementById(\'typeID' + thisRow + '\').value)">Commit</button>';
        }

        function myConfirmRow(thisRow, name, birthplace, type) {
            document.getElementById("myTable").deleteRow(rowNum - thisRow + 1);
            name = unescape(name) || 'name';
            birthplace = unescape(birthplace) || 'birthplace';
            type = unescape(type) || 'type';
            thisRow = thisRow || rowNum + 1;
            var table = document.getElementById("myTable");
            var row = table.insertRow(rowNum - thisRow + 1);
            var cell0 = row.insertCell(0);
            var cell1 = row.insertCell(1);
            var cell2 = row.insertCell(2);
            var cell3 = row.insertCell(3);
            var cell4 = row.insertCell(4);
            cell0.innerHTML = thisRow;
            cell1.innerHTML = '<span id="nameID' + thisRow + '" cols=15 rows=1>' + name + '</span>';
            cell2.innerHTML = '<span id="birthplaceID' + thisRow + '" cols=15 rows=1>' + birthplace + "</span>";
            cell3.innerHTML = '<span id="typeID' + thisRow + '" cols=15 rows=1>' + type + "</span>";
            cell4.innerHTML = '<div class="button"><button onclick="myEditRow(\'' + thisRow + '\',\'' + escape(name) + '\',\'' + escape(birthplace) + '\',\'' + escape(type) + '\')">Edit</button> <button onclick="myRemoveRow(\'' + thisRow + '\',\'' + escape(name) + '\',\'' + escape(birthplace) + '\',\'' + escape(type) + '\')">Delete</button></div>';
        }

        function myDeleteRow(row) {
            document.getElementById("myTable").deleteRow(row);
        }
        
        function myUndoRemoveRow(thisRow, name, birthplace, type) {
            myConfirmRow(thisRow, name, birthplace, type);
        }
        
        function myRemoveRow(thisRow, oldName, oldBirthplace, oldType) {
            document.getElementById("myTable").deleteRow(rowNum - thisRow + 1);
            var name = "!";
            var birthplace = "!";
            var type = "!";
            var table = document.getElementById("myTable");
            var row = table.insertRow(rowNum - thisRow + 1);
            var cell0 = row.insertCell(0);
            var cell1 = row.insertCell(1);
            var cell2 = row.insertCell(2);
            var cell3 = row.insertCell(3);
            var cell4 = row.insertCell(4);
            cell0.innerHTML = thisRow;
            cell1.innerHTML = '<span id="nameID' + thisRow + '" cols=15 rows=1>' + name + '</span>';
            cell2.innerHTML = '<span id="birthplaceID' + thisRow + '" cols=15 rows=1>' + birthplace + "</span>";
            cell3.innerHTML = '<span id="typeID' + thisRow + '" cols=15 rows=1>' + type + "</span>";
            cell4.innerHTML = '<div class="button"><button onclick="myUndoRemoveRow(\'' + thisRow + '\',\'' + oldName + '\',\'' + oldBirthplace + '\',\'' + oldType + '\')">Undo</button></div>';
        }
    </script>

</body>

</html>
